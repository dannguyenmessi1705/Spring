# Dùng Kubernetes thay thế EurekaServer
## 1. Giới thiệu
`EurekaServer` là một service registry và discovery server của Netflix. Nó giúp các service khác đăng ký và tìm kiếm các service khác thông qua REST API hoặc giao thức `Eureka`. Tuy nhiên, `Eureka` không còn được Netflix phát triển và hỗ trợ nữa, hơn nữa cần phải cài đặt và duy trì một server riêng biệt. Vì vậy, trong bài viết này, chúng ta sẽ thay thế `EurekaServer` bằng `Kubernetes` để làm service registry và discovery server.

### 1.1. Khám phá service và thực hiện cân bằng tải ở phía client (EurekaServer)
Trong việc khám phá các service ở phía `client-side`, các ứng dụng chịu trách nhiệm phải tự đăng ký cho chính nó với `service registry` và sau đó tìm kiếm các service khác thông qua `service registry`. 

Khi một ứng dụng cần giao tiếp với một `backing service` hay các service khác, nó truy vấn đến `server registry` cho thông tin về địa chỉ `IP Adr4ess` được liên kết. Nếu nhiều `instances` của service đó tồn tại, `service registry` sẽ trả về một danh sách các `IP Address` của các `instances` đó. Ứng dụng sẽ chọn một `instance` từ danh sách đó để tạo ra chiến lược cân bằng tải.

### 1.2. Khám phá service và thực hiện cân bằng tải ở phía server (Kubernetes)
Trong việc khám phá các service ở phía `server-side`, `K8s discovery server` sẽ chịu trách nhiệm trong việc quan sát, theo dõi các ứng dụng và giữ thông tin của chúng.

Khi có 1 `microservices` cần giao tiếp với `backing service` hay các service khác, nó đơn giản là gọi tới URL đã được `expose` ra bởi `K8s`. `K8s` sẽ quản lý, thực hiện việc cân bằng tải các request ở tầng `server`. Vì vậy `clients` không cần phải tự xấy dựng chiến lược cân bằng tải.

## 2. Triển khai discovery server bằng Kubernetes
Tham khảo tại link sau: [Spring Cloud Kubernetes](https://docs.spring.io/spring-cloud-kubernetes/reference/)

### 2.1. Tạo file `yaml` để triển khai `K8s discovery server`
Tham khảo tại link sau: [Spring Cloud Kubernetes Discovery Server](https://docs.spring.io/spring-cloud-kubernetes/reference/spring-cloud-kubernetes-discoveryserver.html)

Nội dung của file `yaml`:
> kubernetes-discoveryserver.yaml
```yaml
---
apiVersion: v1
kind: List # Khai báo kiểu resource cần triển khai
items: # Khai báo các resource cần triển khai
  - apiVersion: v1  
    kind: Service # Khai báo kiểu resource là Service
    metadata: 
      labels:
        app: spring-cloud-kubernetes-discoveryserver # Nhãn của resource
      name: spring-cloud-kubernetes-discoveryserver # Tên của resource
    spec: # Khai báo thông tin cấu hình của resource
      ports:
        - name: http
          port: 80
          targetPort: 8761 # Port của container 
      selector: # Chọn các pod có nhãn app=spring-cloud-kubernetes-discoveryserver
        app: spring-cloud-kubernetes-discoveryserver 
      type: ClusterIP # Loại Service là ClusterIP, chỉ có thể truy cập từ trong cluster
  - apiVersion: v1 
    kind: ServiceAccount # Khai báo kiểu resource là ServiceAccount
    metadata: 
      labels:
        app: spring-cloud-kubernetes-discoveryserver # Nhãn của resource
      name: spring-cloud-kubernetes-discoveryserver 
  - apiVersion: rbac.authorization.k8s.io/v1 
    kind: RoleBinding # Khai báo kiểu resource là RoleBinding
    metadata:
      labels:
        app: spring-cloud-kubernetes-discoveryserver # Nhãn của resource
      name: spring-cloud-kubernetes-discoveryserver:view
    roleRef: # Phân quyền cho ServiceAccount
      kind: Role # Kiểu phân quyền
      apiGroup: rbac.authorization.k8s.io # Nhóm API
      name: namespace-reader # Tên của Role
    subjects: # Danh sách các ServiceAccount được phân quyền
      - kind: ServiceAccount  # Kiểu ServiceAccount
        name: spring-cloud-kubernetes-discoveryserver # Tên của ServiceAccount được phân quyền
  - apiVersion: rbac.authorization.k8s.io/v1 # Phiên bản API
    kind: Role # Kiểu resource
    metadata: # Thông tin metadata
      namespace: default # Namespace mà Role này thuộc về
      name: namespace-reader # Tên của Role
    rules: # Quy tắc phân quyền
      - apiGroups: ["", "extensions", "apps"] # Nhóm API
        resources: ["pods", "services", "endpoints"] # Resource được phân quyền
        verbs: ["get", "list", "watch"] # Các hành động được phân quyền 
  - apiVersion: apps/v1 # Phiên bản API
    kind: Deployment # Kiểu resource
    metadata:
      name: spring-cloud-kubernetes-discoveryserver-deployment # Tên của resource
    spec: # Thông tin cấu hình của resource
      selector:
        matchLabels: # Chọn các pod có nhãn app=spring-cloud-kubernetes-discoveryserver
          app: spring-cloud-kubernetes-discoveryserver 
      template: # Template của Pod
        metadata:
          labels:
            app: spring-cloud-kubernetes-discoveryserver  
        spec: # Thông tin cấu hình của Pod
          serviceAccountName: spring-cloud-kubernetes-discoveryserver # Tên của ServiceAccount
          containers: 
          - name: spring-cloud-kubernetes-discoveryserver # Tên của container
            image: springcloud/spring-cloud-kubernetes-discoveryserver:3.1.0 # Image của container, pull từ Docker Hub
            imagePullPolicy: IfNotPresent # Chính sách pull image nếu chưa có trên node
            readinessProbe: # Khai báo endpoint kiểm tra readiness của container, nếu container check fail thì sẽ restart container cho đến khi check pass
              httpGet: # Kiểu kiểm tra HTTP GET
                port: 8761 # Port của container
                path: /actuator/health/readiness # Endpoint kiểm tra readiness
              initialDelaySeconds: 100 # Thời gian chờ trước khi kiểm tra readiness
              periodSeconds: 30 # Chu kỳ kiểm tra readiness trong 30s
            livenessProbe: # Khai báo endpoint kiểm tra liveness của container, nếu container check fail thì sẽ restart container cho đến khi check pass
              httpGet: # Kiểu kiểm tra HTTP GET
                port: 8761 # Port của container
                path: /actuator/health/liveness # Endpoint kiểm tra liveness
              initialDelaySeconds: 100 # Thời gian chờ trước khi kiểm tra liveless
              periodSeconds: 30 # Chu kỳ kiểm tra liveness trong 30s
            ports: 
            - containerPort: 8761 # Port của container
```

### 2.2. Triển khai `K8s discovery server` lên `Kubernetes`
Sử dụng lệnh sau để triển khai `K8s discovery server` lên `Kubernetes`:
```bash
kubectl apply -f kubernetes-discoveryserver.yaml
```

> Nên dùng lệnh này để triển khai lên `Kubernetes` chứ không nen dùng `Helm chart` bởi vì `Helm chart` không hỗ trợ `Spring Cloud Kubernetes`. Hơn nữa, `Spring Cloud Kubernetes` không có sự thay đổi nào trong cấu hình, nó luôn cố định với các cấu hình mặc định.