# Giao tiếp từ bên ngoài vào trong Microsevices
## 1. Giới thiệu
Trong chủ đề này, chúng ta sẽ tìm hiểu về các khái niệm như:
- `Gateway`: là một dịch vụ đầu vào của hệ thống, nó nhận các request từ `bên ngoài` và `chuyển tiếp` đến các dịch vụ khác `trong hệ thống microservices`.
- `Routing`: là quá trình xác định cách mà một request sẽ được chuyển tiếp từ `gateway` đến `dịch vụ` trong `microservices` cụ thể.
- `Cross-cutting concerns`: là các vấn đề mà mọi dịch vụ trong hệ thống đều cần xử lý, như `logging`, `security`, `monitoring`, `rate limiting`, `caching`, `etc`.

Tất cả những việc này cấu thành `Edge Server/ API Gateway` đóng vai trò như một máy chủ quản lý các request từ bên ngoài và chuyển tiếp đến các dịch vụ khác trong hệ thống.

> Để xây dựng `Edge Server/ API Gateway`, chúng ta có thể sử dụng các công nghệ như `Spring Cloud Gateway`, `Jewel`, `Zuul`, `Kong`, `Nginx`, `Traefik`, `Envoy`, `etc`.

## 2. Spring Cloud Gateway
### 2.1. Giới thiệu
`Spring Cloud Gateway` hợp lý hóa việc tạo các `dịch vụ biên` bằng cách nhấn mạnh vào tính dễ dàng và hiệu quả. Hơn nữa, do sử dụng react framework, nó có thể `mở rộng liền mạch` để xử lý khối lượng công việc đáng kể thường `phát sinh ở rìa hệ thống` trong khi vẫn `duy trì khả năng mở rộng tối ưu`.

Dưới đây là các khía cạnh chính của `Spring Cloud Gateway`:
- `Cổng dịch vụ` đóng vai trò là `người gác cổng - gatekeeper` cho tất cả lưu lượng truy cập đến các API microservices trong ứng dụng của chúng ta. Khi có cổng dịch vụ, khách hàng dịch vụ `không bao giờ` `calls trực tiếp` URL của một dịch vụ riêng lẻ mà thay vào đó thực hiện tất cả các `cuộc gọi đến cổng dịch vụ`.
- `Spring Cloud Gateway` là một thư viện để `xây dựng một cổng API` nên nó trông giống như bất kỳ ứng dụng Spring Boot nào khác.
- `Spring Cloud Gateway` được thiết kế để đặt `giữa` `người yêu cầu` và `tài nguyên đang được yêu cầu`, nơi nó `chặn`, `phân tích` và `sửa đổi` mọi yêu cầu. Điều đó có nghĩa là bạn có thể định tuyến các yêu cầu dựa trên ngữ cảnh của chúng. Yêu cầu có bao gồm tiêu đề cho biết phiên bản API không? Chúng tôi có thể định tuyến yêu cầu đó đến phần phụ trợ được phiên bản phù hợp. Yêu cầu có yêu cầu phiên cố định không? Cổng có thể theo dõi phiên của từng người dùng.

`Cổng dịch vụ` nằm `giữa` tất cả các `cuộc gọi từ máy khách đến các dịch vụ riêng lẻ` và` hoạt động như một Điểm thực thi chính sách (PEP)` trung tâm như:
- Định tuyến (Cả tĩnh và động)
- Bảo mật (Xác thực & Ủy quyền)
- Ghi nhật ký, kiểm tra và số liệu

[Spring Cloud Gateway](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/)

### 2.2. Cài đặt
#### 2.2.1. Tạo dự án Spring Boot với Spring Cloud Gateway
Để cài đặt `Gateway Server` chúng ta sử dụng các `dependency` sau:
- `Spring Cloud Gateway`: là thư viện chính của `Gateway Server`, dùng để xử lý các request từ bên ngoài và chuyển tiếp đến các dịch vụ khác trong hệ thống. (Lưu ý: Chọn `Reactive Gateway` trong `Spring Initializr`).
>pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```
- `Spring Cloud Config Client`: là thư viện dùng để cấu hình `Gateway Server` từ `Config Server`.
>pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>
```
- `Spring Cloud Eureka Client`: là thư viện dùng để đăng ký `Gateway Server` lên `Eureka Server`.
>pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```
- `Spring Boot Actuator`: là thư viện dùng để quản lý và giám sát `Gateway Server`.
>pom.xml
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```
- Ngoài ra nên thêm `DevTools` để tiện cho việc phát triển.
> Lưu ý: Cần cấu hình `Config Server` và `Eureka Server` trước khi cấu hình `Gateway Server`. Và cần phải thêm các `tag` của `Spring Cloud` như `<properties></properties>`, `<dependencyManagement></dependencyManagement>`.

### 2.2.2. Cấu hình Spring Cloud Gateway, kết nối tới `Config Server` và `Eureka Server`
>application.yml
```yml
spring:
  application:
    name: "gatewayserver"
  config:
    import: optional:configserver:http://localhost:8071
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true # Cho phép Gateway Server sử dụng Eureka để tìm kiếm, định tuyến các service
          lowerCaseServiceId: true # Chuyển tên service thành chữ thường, tránh lỗi khi gọi service

management:
  endpoints:
    web:
      exposure:
        include: "*" # Cho phép hiển thị tất cả các endpoint
  endpoint:
    gateway:
      enabled: true # Cho phép dùng endpoint /actuator/gateway để xem thông tin về các route
  info:
    env:
      enabled: true # Cho phép dùng endpoint /actuator/info để xem thông tin về service

info: # Thông tin về service hiển thị trên Eureka dashboard
  app:
    name: "gatewayserver"
    description: "Bank Gateway Server Application Microservices"
    version: "1.0.0"

# Cấu hình ở Config Server
server:
  port: 8072

eureka:
  instance:
    prefer-ip-address: true
  client:
    fetch-registry: true
    register-with-eureka: true
    service-url:
      defaultZone: http://localhost:8070/eureka/
```

Sau khi cấu hình xong, chạy lần lượt `Config Server`, `Eureka Server`, `Microservices` và cuối cùng là `Gateway Server`. Sau đó, truy cập vào đường dẫn `http://localhost:8072/actuator/gateway/routes` để xem thông tin về các route.

### 2.2.3. Request từ bên ngoài vào trong Microservices
Sau khi cấu hình xong, chúng ta sẽ thực hiện các request từ bên ngoài vào trong `Microservices` thông qua `Gateway Server`.

Để thực hiện việc này, chúng ta thay vì truy cập vào trực tiếp từng `Microservices` (sẽ bị giấu) thì sẽ truy cập vào `Gateway Server` và `Gateway Server` sẽ chuyển tiếp request đó đến `Microservices` tương ứng bằng cách: `http://localhost:8072/{service-name}/{path}`. Trong đó:
- `service-name`: là tên của `Microservices`. Để xem tên của `Microservices` chúng ta có thể truy cập vào `Eureka Dashboard`. (Lưu ý thêm `lowerCaseServiceId: true` trong cấu hình `Gateway Server` để chuyển tên service thành chữ thường).
- `path`: là đường dẫn của `Microservices`.
> Ví dụ: `Get Accounts` của `Account Service` có `spring.application.name` là `accounts` sẽ là `http://localhost:8080/api/fetch?mobileNumber=0258920585`.
> Truy cập vào `Gateway Server` sẽ là `http://localhost:8072/accounts/api/fetch?mobileNumber=0258920585`.

