# VAULT SPRING BOOT
## 1. Giới thiệu
Vault là một công cụ mã nguồn mở được phát triển bởi HashiCorp, giúp quản lý và bảo mật các thông tin nhạy cảm như password, token, key, certificate, ...

Trong bài viết này, chúng ta sẽ tìm hiểu cách sử dụng Vault trong ứng dụng SpringBoot.

## 2. Cài đặt Vault
### 2.1. Cài đặt Vault
Để cài đặt HashiCorp Vault, có thể sử dụng Docker Compose:
```yaml
services:
  vault:
    image: hashicorp/vault:1.18.3
    container_name: vault
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root # Token để truy cập vào vault
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200" # Địa chỉ của vault server
      VAULT_LOCAL_CONFIG: | # Cấu hình để bật giao diện web của vault
        {
          "ui": true,
        } 
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK # Cấp quyền để vault có thể sử dụng memory lock (để lưu trữ dữ liệu)
    volumes:
      - ./vault-init.sh:/vault-init.sh
      - ./policy.hcl:/policy.hcl
    entrypoint: ["/bin/sh", "-c", "/vault-init.sh"]
```

File `policy.hcl`:
```hcl
path "kv/data/*" {
  capabilities = ["read"]
}
```

File `vault-init.sh`:
```bash
#!/bin/sh

set -e

export VAULT_ADDR="http://127.0.0.1:8200"
export VAULT_FORMAT="json"
export VAULT_TOKEN="root"

vault server -dev -dev-listen-address="0.0.0.0:8200" &
sleep 5s

echo "✅ Vault đã khởi động. Tiến hành cấu hình..."

vault login -no-print "${VAULT_TOKEN}"

echo "🔹 Bật Key Value Secrets Engine..."
vault secrets enable -path=kv kv-v2

echo "🔹 Tạo dữ liệu bí mật..."
vault kv put kv/database db-name="DBTEST" db-password="12345"

echo "🔹 Tạo chính sách truy cập..."
vault policy write my-policy /policy.hcl

echo "🔹 Bật AppRole Authentication..."
vault auth enable approle

echo "🔹 Tạo Role cho AppRole với token không hết hạn ..."
vault write auth/approle/role/my-role secret_id_ttl=0s token_ttl=0s token_max_ttl=0s token_policies=my-policy

echo "🔹 Lấy Role ID..."
ROLE_ID=$(vault read -field=role_id auth/approle/role/my-role/role-id)
echo "ROLE_ID=$ROLE_ID"

echo "🔹 Lấy Secret ID..."
SECRET_ID=$(vault write -f -field=secret_id auth/approle/role/my-role/secret-id)
echo "SECRET_ID=$SECRET_ID"

echo "🔹 Gán approle, Role ID & Secret ID vào biến môi trường cho Spring Boot..."
mkdir -p /vault/secrets/
echo "VAULT_TOKEN=$VAULT_TOKEN" > /vault/secrets/vault-credentials.env
echo "VAULT_ADDR=$VAULT_ADDR" >> /vault/secrets/vault-credentials.env
echo "ROLE_ID=$ROLE_ID" >> /vault/secrets/vault-credentials.env
echo "SECRET_ID=$SECRET_ID" >> /vault/secrets/vault-credentials.env

echo "✅ Vault đã được cấu hình hoàn tất!"

# this container is now healthy
touch /tmp/healthy

# keep container alive
tail -f /dev/null & trap 'kill %1' TERM ; wait
```

### 2.2. Cài đặt Vault Client trên Spring Boot
Thêm dependency vào `pom.xml`:
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-vault-config</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-vault-core</artifactId>
</dependency>
```

Cấu hình `application.yml`:
```yaml 
spring:
  cloud:
    vault:
      enabled: true # Bật cấu hình Vault
      authentication: approle # Phương thức xác thực với Vault (AppRole)
      app-role: # Cấu hình AppRole để xác thực với Vault
        role-id: 41ca3cab-ec9c-f72b-43af-3af3a9693f09
        secret-id: 90311fd4-1f2b-1174-baad-f8c1b0f2c8bf
      host: localhost # Địa chỉ của Vault
      port: 8200 # Cổng của Vault
      scheme: http # Giao thức truy cập vào Vault
      fail-fast: true # Làm cho ứng dụng bị lỗi nếu không thể kết nối đến Vault
      config:
        lifecycle:
          enabled: true # 
      generic:
        enabled: false
    config:
      enabled: false
  application:
    name: vault-spring-boot

app:
  vaultConfigs:
    vault-key-path: /v1/kv/data/database
    db-name: db-name # Key chứa tên database trong Vault đã add vào kv của Vault ở file vault-init.sh
    db-password: db-password # Key chứa password trong Vault đã add vào kv của Vault ở file vault-init.sh
```

Tạo class `Database` để lưu thông tin database:
```java
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import com.fasterxml.jackson.annotation.JsonProperty;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class Database {
    @JsonProperty("db-name") // Tên key trong Vault
    private String dbName;

    @JsonProperty("db-password") // Tên key trong Vault
    private String dbPassword;
}
```

Tạo class `VaultData` để lưu dữ liệu từ Vault:
```java
import lombok.Data;

@Data
public class VaultData {
    private Database data;
}
```


Tạo `VaultConfig` để đọc dữ liệu từ Vault:
```java
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import lombok.Setter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.springframework.vault.core.VaultOperations;
import org.springframework.vault.support.VaultResponseSupport;
import javax.annotation.PostConstruct;

@Getter
@Setter
@Component
@Slf4j
@RequiredArgsConstructor
public class VaultConfig {

    @Value("${app.vaultConfigs.vault-key-path}")
    private String vaultKeyPath; // Đường dẫn key trong Vault

    @Value("${app.vaultConfigs.db-name}")
    private String dbName; // Key chứa tên database trong Vault

    @Value("${app.vaultConfigs.db-password}")
    private String dbPassword; // Key chứa password trong Vault

    @Value("${spring.cloud.vault.host}")
    private String vaultHost; // Địa chỉ của Vault

    @Value("${spring.cloud.vault.port}")
    private int vaultPort; // Cổng của Vault

    @Value("${spring.cloud.vault.scheme}")
    private String vaultScheme; // Giao thức truy cập vào Vault

    private final VaultOperations vaultOperations; // Bean của VaultOperations để đọc dữ liệu từ Vault
    private Database database; // Biến lưu thông tin database lấy từ Vault

    @PostConstruct // Khi bean được khởi tạo, hàm này sẽ được gọi 
    public void init() {
        String endpoint = vaultScheme + "://" + vaultHost + ":" + vaultPort + vaultKeyPath;
        log.info("Reading data from Vault...");
        VaultResponseSupport<VaultData> response = vaultOperations.read(endpoint, VaultData.class); // Đọc dữ liệu từ Vault theo đường dẫn và lưu vào VaultData object
        database = response.getData().getData(); // Lấy dữ liệu từ Vault lưu vào biến database
        log.info("Data from Vault: {}", database); // Log dữ liệu lấy từ Vault
    }

    public Database getDatabase() {
        return database;
    } // Getter của biến database
}
```

Tạo `RestController` để test:
```java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class VaultController {

    @Autowired
    private VaultConfig vaultConfig;

    @GetMapping("/database")
    public Database getDatabase() {
        return vaultConfig.getDatabase();
    }
}
```

Chạy ứng dụng và truy cập vào `http://localhost:8080/database` để xem kết quả.