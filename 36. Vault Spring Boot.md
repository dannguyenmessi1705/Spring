# VAULT SPRING BOOT
## 1. Giá»›i thiá»‡u
Vault lÃ  má»™t cÃ´ng cá»¥ mÃ£ nguá»“n má»Ÿ Ä‘Æ°á»£c phÃ¡t triá»ƒn bá»Ÿi HashiCorp, giÃºp quáº£n lÃ½ vÃ  báº£o máº­t cÃ¡c thÃ´ng tin nháº¡y cáº£m nhÆ° password, token, key, certificate, ...

Trong bÃ i viáº¿t nÃ y, chÃºng ta sáº½ tÃ¬m hiá»ƒu cÃ¡ch sá»­ dá»¥ng Vault trong á»©ng dá»¥ng SpringBoot.

## 2. CÃ i Ä‘áº·t Vault
### 2.1. CÃ i Ä‘áº·t Vault
Äá»ƒ cÃ i Ä‘áº·t HashiCorp Vault, cÃ³ thá»ƒ sá»­ dá»¥ng Docker Compose:
```yaml
services:
  vault:
    image: hashicorp/vault:1.18.3
    container_name: vault
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root # Token Ä‘á»ƒ truy cáº­p vÃ o vault
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200" # Äá»‹a chá»‰ cá»§a vault server
      VAULT_LOCAL_CONFIG: | # Cáº¥u hÃ¬nh Ä‘á»ƒ báº­t giao diá»‡n web cá»§a vault
        {
          "ui": true,
        } 
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK # Cáº¥p quyá»n Ä‘á»ƒ vault cÃ³ thá»ƒ sá»­ dá»¥ng memory lock (Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u)
    volumes:
      - ./vault-init.sh:/vault-init.sh
      - ./policy.hcl:/policy.hcl
    entrypoint: ["/bin/sh", "-c", "/vault-init.sh"]
```

File `policy.hcl`:
```hcl
path "kv/data/*" {
  capabilities = ["read"]
}
```

File `vault-init.sh`:
```bash
#!/bin/sh

set -e

export VAULT_ADDR="http://127.0.0.1:8200"
export VAULT_FORMAT="json"
export VAULT_TOKEN="root"

vault server -dev -dev-listen-address="0.0.0.0:8200" &
sleep 5s

echo "âœ… Vault Ä‘Ã£ khá»Ÿi Ä‘á»™ng. Tiáº¿n hÃ nh cáº¥u hÃ¬nh..."

vault login -no-print "${VAULT_TOKEN}"

echo "ğŸ”¹ Báº­t Key Value Secrets Engine..."
vault secrets enable -path=kv kv-v2

echo "ğŸ”¹ Táº¡o dá»¯ liá»‡u bÃ­ máº­t..."
vault kv put kv/database db-name="DBTEST" db-password="12345"

echo "ğŸ”¹ Táº¡o chÃ­nh sÃ¡ch truy cáº­p..."
vault policy write my-policy /policy.hcl

echo "ğŸ”¹ Báº­t AppRole Authentication..."
vault auth enable approle

echo "ğŸ”¹ Táº¡o Role cho AppRole vá»›i token khÃ´ng háº¿t háº¡n ..."
vault write auth/approle/role/my-role secret_id_ttl=0s token_ttl=0s token_max_ttl=0s token_policies=my-policy

echo "ğŸ”¹ Láº¥y Role ID..."
ROLE_ID=$(vault read -field=role_id auth/approle/role/my-role/role-id)
echo "ROLE_ID=$ROLE_ID"

echo "ğŸ”¹ Láº¥y Secret ID..."
SECRET_ID=$(vault write -f -field=secret_id auth/approle/role/my-role/secret-id)
echo "SECRET_ID=$SECRET_ID"

echo "ğŸ”¹ GÃ¡n approle, Role ID & Secret ID vÃ o biáº¿n mÃ´i trÆ°á»ng cho Spring Boot..."
mkdir -p /vault/secrets/
echo "VAULT_TOKEN=$VAULT_TOKEN" > /vault/secrets/vault-credentials.env
echo "VAULT_ADDR=$VAULT_ADDR" >> /vault/secrets/vault-credentials.env
echo "ROLE_ID=$ROLE_ID" >> /vault/secrets/vault-credentials.env
echo "SECRET_ID=$SECRET_ID" >> /vault/secrets/vault-credentials.env

echo "âœ… Vault Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh hoÃ n táº¥t!"

# this container is now healthy
touch /tmp/healthy

# keep container alive
tail -f /dev/null & trap 'kill %1' TERM ; wait
```

### 2.2. CÃ i Ä‘áº·t Vault Client trÃªn Spring Boot
ThÃªm dependency vÃ o `pom.xml`:
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-vault-config</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-vault-core</artifactId>
</dependency>
```

Cáº¥u hÃ¬nh `application.yml`:
```yaml 
spring:
  cloud:
    vault:
      enabled: true # Báº­t cáº¥u hÃ¬nh Vault
      authentication: approle # PhÆ°Æ¡ng thá»©c xÃ¡c thá»±c vá»›i Vault (AppRole)
      app-role: # Cáº¥u hÃ¬nh AppRole Ä‘á»ƒ xÃ¡c thá»±c vá»›i Vault
        role-id: 41ca3cab-ec9c-f72b-43af-3af3a9693f09
        secret-id: 90311fd4-1f2b-1174-baad-f8c1b0f2c8bf
      host: localhost # Äá»‹a chá»‰ cá»§a Vault
      port: 8200 # Cá»•ng cá»§a Vault
      scheme: http # Giao thá»©c truy cáº­p vÃ o Vault
      fail-fast: true # LÃ m cho á»©ng dá»¥ng bá»‹ lá»—i náº¿u khÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n Vault
      config:
        lifecycle:
          enabled: true # 
      generic:
        enabled: false
    config:
      enabled: false
  application:
    name: vault-spring-boot

app:
  vaultConfigs:
    vault-key-path: /v1/kv/data/database
    db-name: db-name # Key chá»©a tÃªn database trong Vault Ä‘Ã£ add vÃ o kv cá»§a Vault á»Ÿ file vault-init.sh
    db-password: db-password # Key chá»©a password trong Vault Ä‘Ã£ add vÃ o kv cá»§a Vault á»Ÿ file vault-init.sh
```

Táº¡o class `Database` Ä‘á»ƒ lÆ°u thÃ´ng tin database:
```java
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import com.fasterxml.jackson.annotation.JsonProperty;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class Database {
    @JsonProperty("db-name") // TÃªn key trong Vault
    private String dbName;

    @JsonProperty("db-password") // TÃªn key trong Vault
    private String dbPassword;
}
```

Táº¡o class `VaultData` Ä‘á»ƒ lÆ°u dá»¯ liá»‡u tá»« Vault:
```java
import lombok.Data;

@Data
public class VaultData {
    private Database data;
}
```


Táº¡o `VaultConfig` Ä‘á»ƒ Ä‘á»c dá»¯ liá»‡u tá»« Vault:
```java
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import lombok.Setter;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.springframework.vault.core.VaultOperations;
import org.springframework.vault.support.VaultResponseSupport;
import javax.annotation.PostConstruct;

@Getter
@Setter
@Component
@Slf4j
@RequiredArgsConstructor
public class VaultConfig {

    @Value("${app.vaultConfigs.vault-key-path}")
    private String vaultKeyPath; // ÄÆ°á»ng dáº«n key trong Vault

    @Value("${app.vaultConfigs.db-name}")
    private String dbName; // Key chá»©a tÃªn database trong Vault

    @Value("${app.vaultConfigs.db-password}")
    private String dbPassword; // Key chá»©a password trong Vault

    @Value("${spring.cloud.vault.host}")
    private String vaultHost; // Äá»‹a chá»‰ cá»§a Vault

    @Value("${spring.cloud.vault.port}")
    private int vaultPort; // Cá»•ng cá»§a Vault

    @Value("${spring.cloud.vault.scheme}")
    private String vaultScheme; // Giao thá»©c truy cáº­p vÃ o Vault

    private final VaultOperations vaultOperations; // Bean cá»§a VaultOperations Ä‘á»ƒ Ä‘á»c dá»¯ liá»‡u tá»« Vault
    private Database database; // Biáº¿n lÆ°u thÃ´ng tin database láº¥y tá»« Vault

    @PostConstruct // Khi bean Ä‘Æ°á»£c khá»Ÿi táº¡o, hÃ m nÃ y sáº½ Ä‘Æ°á»£c gá»i 
    public void init() {
        String endpoint = vaultScheme + "://" + vaultHost + ":" + vaultPort + vaultKeyPath;
        log.info("Reading data from Vault...");
        VaultResponseSupport<VaultData> response = vaultOperations.read(endpoint, VaultData.class); // Äá»c dá»¯ liá»‡u tá»« Vault theo Ä‘Æ°á»ng dáº«n vÃ  lÆ°u vÃ o VaultData object
        database = response.getData().getData(); // Láº¥y dá»¯ liá»‡u tá»« Vault lÆ°u vÃ o biáº¿n database
        log.info("Data from Vault: {}", database); // Log dá»¯ liá»‡u láº¥y tá»« Vault
    }

    public Database getDatabase() {
        return database;
    } // Getter cá»§a biáº¿n database
}
```

Táº¡o `RestController` Ä‘á»ƒ test:
```java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class VaultController {

    @Autowired
    private VaultConfig vaultConfig;

    @GetMapping("/database")
    public Database getDatabase() {
        return vaultConfig.getDatabase();
    }
}
```

Cháº¡y á»©ng dá»¥ng vÃ  truy cáº­p vÃ o `http://localhost:8080/database` Ä‘á»ƒ xem káº¿t quáº£.