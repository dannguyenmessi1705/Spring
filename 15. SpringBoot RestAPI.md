# Restful API trong Spring Boot
## 1. Giới thiệu
`Restful API` là một kiến trúc phần mềm dựa trên giao thức `HTTP` mà các `API` đều được xây dựng dựa trên các phương thức `HTTP` như `GET`, `POST`, `PUT`, `DELETE`. `Restful API` không lưu trạng thái của `client` trên `server`, mà nó sẽ lưu trạng thái của `client` trên `client` và `server` sẽ không lưu trạng thái của `client`.

## 2. Tạo Restful API trong Spring Boot
### 2.1. Tạo Restful API
Để tạo `Restful API` trong `Spring Boot`, chúng ta sẽ tạo một `Controller` và sử dụng các annotation của `Spring` như `@RestController`, `@GetMapping`, `@PostMapping`, `@PutMapping`, `@DeleteMapping`.

Khác với `Spring MVC`, `Spring Boot` không sử dụng `@Controller` mà sử dụng `@RestController`. 
Khác với `Spring MVC`, `Spring Boot` không sử dụng `@RequestMapping(value="/", RequestMethod.GET, ....)` mà sử dụng `@GetMapping(path="/")`, `@PostMapping(path="/")`, `@PutMapping(path="/")`, `@DeleteMapping(path="/")`.

Ví dụ:
```java
Thay vì trả về `View` như `Spring MVC`, `@RestController` sẽ trả về dữ liệu dưới dạng `JSON` hoặc `XML`.
```java
package com.didan.spring_boot_web.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController // Đánh dấu đây là một RestController
public class HelloController {

    @GetMapping(path = "/hello") // Khi có request GET đến /hello thì phương thức này sẽ được gọi
    public String hello() {
        return "Hello World!";
    }
}
```
Khi chúng ta truy cập vào `http://localhost:8080/hello` thì sẽ nhận được dữ liệu `Hello World!`. Nhưng dữ liệu ở đây chỉ là dạng `String`, `Text` chứ không phải là `JSON` hoặc `XML`.

### 2.2. Trả về dữ liệu dưới dạng JSON
Để trả về dữ liệu dưới dạng `JSON`, chúng ta trả về Bean hoặc `List` của Bean. `Spring Boot` sẽ tự động chuyển đổi Bean hoặc `List` của Bean sang dạng `JSON` nhờ `@ResponseBody` và `JacksonHttpMessageConverter` (đã được tích hợp sẵn trong `Spring Boot`).

Lưu ý Bean cần có `getter` và `setter` hoặc `constructor` có tham số để map dữ liệu truyền vào và chuyển đổi dữ liệu sang dạng `JSON`.

Ví dụ:
>HelloBean.java
```java
package com.didan.spring_boot_web.bean;

public class HelloBean {
    private String message;

    public HelloBean(String message) {
        this.message = message;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
    public String toString() {
        return String.format("HelloBean [message=%s]", message);
    }
}
```
> HelloController.java
```java
package com.didan.spring_boot_web.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController {

    @GetMapping(path = "/hello")
    public HelloBean hello() {
        return new HelloBean("Hello World!");
    }
}
```
Khi chúng ta truy cập vào `http://localhost:8080/hello` thì sẽ nhận được dữ liệu dưới dạng `JSON`:
```json
{
    "message": "Hello World!"
}
```

### 2.3. Thiết lập params, query cho Restful API
Để thiết lập `params`, `query` cho `Restful API`, chúng ta sử dụng `@RequestParam` cho `query` và `@PathVariable` cho `params`.

Ví dụ:
```java
package com.didan.spring_boot_web.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController {

    @GetMapping(path = "/hello/{id}") 
    public HelloBean hello(@RequestParam("name") String name, @PathVariable("id") String id) {
        return new HelloBean("Hello " + name + " with id " + id);
    }
    // VD: http://localhost:8080/hello/1?name=Didan => {"message":"Hello Didan with id 1"}
}
```

### 2.4. Sử dụng `@RequestBody`, `@ModelAttribute` trong Restful API để nhận dữ liệu từ `client`
- `@RequestBody`: Dùng để nhận dữ liệu từ `client` dưới dạng `JSON` hoặc `XML`.
- `@ModelAttribute`: Dùng để nhận dữ liệu từ `client` dưới dạng `FormUrlEncoded`, `Multipart/Form`.

Ví dụ:
```java
package com.didan.spring_boot_web.controller;

import com.didan.spring_boot_web.bean.HelloBean;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestBody;

@RestController
public class HelloController {

    @PostMapping(path = "/hello")
    public HelloBean hello(@RequestBody HelloBean helloBean) {
        return helloBean;
    } // VD: http://localhost:8080/hello với body là {"message":"Hello Didan"} => {"message":"Hello Didan"}

    @PostMapping(path = "/hello")
    public HelloBean hello(@ModelAttribute HelloBean helloBean) {
        return helloBean;
    } // VD: http://localhost:8080/hello với body là message=Hello%20Didan => {"message":"Hello Didan"}
}
```

### 2.5. Trả về `ResponseEntity` trong Restful API
`ResponseEntity` là một class trong `Spring` dùng để trả về `HTTP Status`, `Header`, `Body`.

Chúng ta có thể trả về `ResponseEntity` trong `Restful API` để trả về `HTTP Status` khác nhau, `Header` khác nhau.

Có thể trả về `ResponseEntity` với dữ liệu dạng `JSON`, `XML`, `String`, `Object`.

Có 3 cách để trả về `ResponseEntity` theo thứ tự tham số truyền vào:
- Trả về `ResponseEntity` với chỉ `Body` 
- Trả về `ResponseEntity` với `Body` và `HTTP Status`
- Trả về `ResponseEntity` với `Body`, `Header` và `HTTP Status`

Để có thể trả về `ResponseEntity` chúng ta phải đặt dữ liệu trả về là `ResponseEntity<? hoặc Object>` vào phương thức.

Ví dụ:
> Trả về `ResponseEntity` với`Body`,`Header` và `HTTP Status` do chúng ta thiết lập.
```java
package com.didan.spring_boot_web.controller;

import com.didan.spring_boot_web.bean.HelloBean;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController {

    @GetMapping(path = "/hello")
    public ResponseEntity<? super HelloBean> hello() { // Kiểu trả về phải là ResponseEntity<? super HelloBean>
        HelloBean helloBean = new HelloBean("Hello World!");

        URI location = ServletUriComponentsBuilder.fromCurrentRequest() // Lây ra URI từ request hiện tại
        .path("/{id}") // Thêm một path vào URI với id là tham số truyền vào
        .buildAndExpand(helloBean.getMessage()) // Thêm tham số vào path vừa tạo
        .toUri(); // Chuyển URI thành URI object

        MultiValueMap<String, String> headers = new LinkedMultiValueMap<>(); // Tạo một MultiValueMap để lưu trữ Header
        headers.add("location", location.toString()); // Thêm một Header vào MultiValueMap với key là location, value là URI. Để cho client biết nơi lấy dữ liệu

        return new ResponseEntity<>(helloBean, headers, HttpStatus.OK); // Trả về ResponseEntity với Body là helloBean, Header là headers, HTTP Status là OK, lưu ý thứ tự truyền vào và không có kiểu trả về bên trong ResponseEntity<>
    }
}
```

## 3. Bắt Exception trong Restful API khi xảy ra lỗi truy vấn dữ liệu
Khi xảy ra lỗi trong quá trình truy vấn dữ liệu, chúng ta cần bắt lỗi đó và trả về thông báo lỗi cho `client`.

Để bắt lỗi, ta sử dụng `RuntimeException` để bắt lỗi và trả về thông báo lỗi cho `client`.

`RuntimeException` khác với `Exception` ở chỗ là `RuntimeException` không cần phải khai báo trong phương thức, nó sẽ tự động bắt lỗi khi xảy ra.

Ngoài ra để tùy chỉnh thông báo lỗi + mã lỗi, chúng ta sử dụng `@ResponseStatus` để thiết lập `HTTP Status` cho `Response`. Và tạo 1 class kế thừa `RuntimeException` để tạo ra `Custom Exception`.

Ví dụ: Nếu `id` truyền vào không tồn tại trong `database` thì sẽ trả về `HTTP Status` là `NOT_FOUND` và thông báo lỗi là `ID not found`.
> NotFoundException.java
```java
package com.didan.spring_boot_web.exception;

import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.ResponseStatus;

@ResponseStatus(code = HttpStatus.NOT_FOUND) // Thiết lập HTTP Status là NOT_FOUND
public class NotFoundException extends RuntimeException { // Kế thừa RuntimeException
    public NotFoundException(String message) { // Constructor với tham số là message
        super(message); // Gọi constructor của class cha với tham số là message
    }
}
```

> HelloController.java
```java
...
@RestController
public class HelloController {

    @GetMapping(path = "/hello/{id}")
    public ResponseEntity<? super HelloBean> hello(@PathVariable("id") String id) {
        if (!id.equals("1")) { // Nếu id khác 1 thì ném ra NotFoundException
            throw new NotFoundException("ID not found"); // Ném ra NotFoundException với message là ID not found
        }
        return new ResponseEntity<>(helloBean, HttpStatus.OK);
    }
}
```
Khi chúng ta truy cập vào `http://localhost:8080/hello/2` thì sẽ nhận được thông báo lỗi `ID not found` và `HTTP Status` là `NOT_FOUND`. Nếu sử dụng `Postman` thì thông báo lỗi sẽ tự chuyển về dạng `JSON`.