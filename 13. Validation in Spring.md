# Validation in Spring
## 1. Giới thiệu
Trong bài viết này, chúng ta sẽ tìm hiểu cách sử dụng `Validation` trong ứng dụng Spring.

`Validation` là một cơ chế kiểm tra dữ liệu đầu vào của người dùng. Chúng ta có thể kiểm tra dữ liệu đầu vào của người dùng thông qua `Annotation` hoặc `@Valid`.

## 2. Sử dụng `Validation` trong Spring MVC
Để sư dụng `Validation` trong Spring MVC, chúng ta cần thực hiện các bước sau:

### 2.1. Thêm `dependency` vào `pom.xml`
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

### 2.2. Tạo `Command Bean` (Form Backing Object) chứa dữ liệu cần kiểm tra
Lúc này sẽ tạo ra một class chứa dữ liệu cần kiểm tra, class này sẽ được gọi là `Command Bean` hoặc `Form Backing Object`.

Và sẽ tạo ra 2 ràng buộc (File `.jsp` và `Controller`) để kiểm tra dữ liệu nhập vào.

Ví dụ:

Thêm các `Annotation` vào trên các thuộc tính của class để kiểm tra:
- `@NotNull`: Kiểm tra giá trị không được `null`.
- `@NotEmpty`: Kiểm tra giá trị không được `null` và không được rỗng.
- `@NotBlank`: Kiểm tra giá trị không được `null`, không được rỗng và không được chứa khoảng trắng.
- `@Size`: Kiểm tra kích thước của giá trị.
- `@Email`: Kiểm tra giá trị có đúng định dạng email không.
- `@Pattern`: Kiểm tra giá trị có đúng định dạng không...
- ...

>`User.java`
```java
package com.example.demo;
import javax.validation.constraints.Size;

public class User {
    @Size(min=5, message="Username must be at least 5 characters long") // Kiểm tra username có ít nhất 5 kí tự 
    private String username;
    private String password;

    public User(String username, String password) {
        this.username = username;
        this.password = password;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }
}
```
Thêm `@Valid` và `BindingResult` vào phương thức của `Command Bean` trong `Controller` để kiểm tra dữ liệu:

>`UserController.java`
```java
package com.example.demo;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import jakarta.validation.Valid;
import org.springframework.validation.BindingResult;

@Controller
public class UserController {
    @RequestMapping(value="user", method=RequestMethod.GET)
    public String getUserPage(Model model) {
        User user = new User("admin", "123456"); // Tạo 1 user ngẫu nhiên để truyền vào View, giá trị mặc định
        model.put("user", user); // Truyền user vào Model để hiển thị lên View
        return "user"; // Trả về tên của View
    }

    @RequestMapping(value="user", method=RequestMethod.POST)
    public String postUserPage(@Valid User user, BindingResult result, Model model) {
        if (result.hasErrors()) { // Nếu có lỗi
            return "user"; // Trả về trang user để hiển thị lỗi
        }
        userService.save(user.getUsername()); // Sau khi thực hiện POST, username sẽ được truyền vào đối tượng User, thay vì dùng @RequestParam
        return "redirect:all-users"; // Redirect đến trang hiển thị tất cả user
    }
}
```
Thêm `taglib form` vào `View` để hiển thị lỗi, thẻ của `taglib` sẽ phải dùng `cssClass` để dùng với `class` trong `CSS`:
>`user.jsp`
```jsp
<%@ taglib prefix="form" uri="http://www.springframework.org/tags/form" %> <!-- Thêm taglib để sử dụng form validation -->
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>User Page</title>
</head>
<body>
    <h1>User Page</h1>
    <form:form method="post" modelAttribute="user"> <!-- Sử dụng form:form để tạo form, modelAttribute="user" để bind dữ liệu từ Model vào form -->
        <form:input path="username" /> <!-- Tạo input cho username, với username là thuộc tính của User -->
        <form:errors path="username" cssClass="error" /> <!-- Hiển thị lỗi nếu có lỗi ở username -->
        <form:input type="hidden" path="password" /> <!-- Tạo input cho password -->
        <form:errors path="password" cssClass="error" /> <!-- Hiển thị lỗi nếu có lỗi ở password -->
        <input type="submit" value="Submit" /> <!-- Tạo button submit -->
    </form:form>
</body>
</html>
```
## 3. Sử dụng `Validation` trong Spring Boot RESTful API
Để sử dụng `Validation` trong Spring Boot RESTful API, chúng ta cần thực hiện các bước sau:

### 3.1. Thêm `dependency` vào `pom.xml`
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
```

### 3.2. Tạo `Command Bean` chứa dữ liệu cần kiểm tra
Tạo ra một class chứa dữ liệu cần kiểm tra, class này sẽ được gọi là `Command Bean`.

Ví dụ:
>`User.java`
```java
package com.example.demo;
import javax.validation.constraints.Size;
import javax.validation.constraints.NotNull;

public class User {
    @NotNull
    @Size(min=5, message="Username must be at least 5 characters long")
    private String username;
    private String password;

    // constructor, getter, setter
}
```

### 3.3. Sử dụng `@Validated`, `@Valid` trong `Controller`
Trong `RestFul API`, chúng ta sẽ sử dụng `Validation` để kiểm tra dữ liệu đầu vào của người dùng bằng cách:
- Sử dụng `@Validated` trên đầu `Class` để bắt tất cả các `api` trong `Class` đó phải kiểm tra dữ liệu đầu vào.
- Đặt`@Valid` trước `@RequestBody` hoặc trước `@ModelAttribute` với các class `dữ liệu` được yêu cầu kiểm tra để kiểm tra dữ liệu đầu vào của người dùng trong 1 `method` cụ thể.
- Sử dụng các Annotation kiểm tra dữ liệu đầu vào của người dùng như `@NotNull`, `@Size`, `@Email`, `@Pattern`,...đặt ngay trước các params, fields cần kiểm tra.

Ví dụ:
>`UserController.java`
```java
package com.example.demo;

import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;
import jakarta.validation.Valid;

@RestController
@Validated // Bắt tất cả các api trong class này phải kiểm tra dữ liệu đầu vào
public class UserController {
    @PostMapping("/user")
    public String postUser(@Valid @RequestBody User user) {
        return ...
    } // Nếu không có lỗi, trả về dữ liệu\
        // Nếu có lỗi sẽ trả về BAD_REQUEST với trường thông báo lỗi mặc định của Spring

    @GetMapping("/user")
    public String getUser(@RequestParam 
    @Size(min=5, message="Username must be at least 5 characters long") // Kiểm tra username truyền vào có ít nhất 5 kí tự 
    String username) {
        return ...
    } 
}
```

### 3.4. Tùy chỉnh trường thông báo lỗi trả về (`Xem ở phần 15. Spring Boot RESTful API, mục ### 4.4`)