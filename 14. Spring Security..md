# Spring Security trong Spring Boot
## 1. Giới thiệu về Spring Security
`Spring Security` là một framework mạnh mẽ và mở rộng để xác thực và kiểm tra quyền truy cập trong ứng dụng Spring. `Spring Security` cung cấp một cách tiếp cận bảo mật mạnh mẽ và linh hoạt cho ứng dụng Spring.

`Spring Security` cung cấp các tính năng sau:
- Xác thực (Authentication): Xác thực người dùng.
- Ủy quyền (Authorization): Kiểm tra quyền truy cập của người dùng.
- Bảo vệ chống tấn công CSRF (Cross-Site Request Forgery).
- Bảo vệ chống tấn công XSS (Cross-Site Scripting).
- Bảo vệ chống tấn công Clickjacking.
- Bảo vệ chống tấn công Session Fixation.
- Bảo vệ chống tấn công Session Management.
- Bảo vệ chống tấn công Brute Force.
- ...

`Spring Security` hỗ trợ nhiều cơ chế xác thực khác nhau như:
- Xác thực dựa trên `LDAP` - Lightweight Directory Access Protocol (Giao thức truy cập thư mục nhẹ).
- Xác thực dựa trên `Database` - Cơ sở dữ liệu.
- Xác thực dựa trên `JWT` - JSON Web Token.
- Xác thực dựa trên `OAuth2` - Open Authorization.
- Xác thực dựa trên `In-Memory` - Lưu trữ trong bộ nhớ tạm.

## 2. Sử dụng Spring Security
### 2.1. Thêm `dependency` vào `pom.xml`
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```
Sau khi thêm `dependency` vào `pom.xml`, chúng ta cần khởi động lại ứng dụng Spring Boot.

Khi khởi động ứng dụng, `Spring Security` sẽ tự động tạo ra một `password` ngẫu nhiên cho chúng ta. Để lấy `password` này, chúng ta cần xem trong `Console` khi khởi động ứng dụng.

```plaintext
Using generated security password: 7b3b3b7b-0b7b-4b7b-8b7b-7b7b7b7b7b7b
```

Khi truy cập vào bất kỳ 1 route nào của ứng dụng, `Spring Security` tự chuyển hướng về `/login` sẽ yêu cầu nhập `username` và `password` để xác thực. Với `username` là `user` và `password` là `password` mặc định ở trong `Console` và được làm mới mỗi lần khởi động ứng dụng.

Đê `logout` khỏi ứng dụng, chúng ta chỉ cần truy cập vào `/logout`.

### 2.2. Thiết lập `application.properties` (RESTAPI: `Basic Authentication`)
Sau khi cho `Spring Security` chạy lần đầu, chúng ta cần thiết lập `username` và `password` mặc định cho ứng dụng. Tránh việc mỗi lần khởi động ứng dụng, `Spring Security` tạo ra `password` mới.
```properties
spring.security.user.name=didannguyen
spring.security.user.password=12345
```

### 2.3. Cấu hình `Spring Security` tạo `User` trong bộ nhớ (In-Memory) (RESTAPI: `Basic Authentication`)
Để cấu hình `Spring Security`, chúng ta cần tạo một class với `@Configuration` để cho `Spring Security` biết đây là class cấu hình.

>Lưu ý: Nếu dùng `Spring Boot` tạo `API` thì phải kế thừa `WebSecurityConfigurerAdapter`.
>Lưu ý: Nếu dùng `SpringMVC` thì không cần phải kế thừa class nào cả.

```java
package com.didan.spring_boot_web.securtity;

import java.util.function.Function;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;

@Configuration // Đánh dấu đây là class cấu hình Spring (Bên trong có thể chứa các Bean)
public class SpringSecurityConfiguration {

	@Bean // Bean này sẽ được Spring quản lý
	public PasswordEncoder passwordEncoder() { // Bean này trả về một đối tượng PasswordEncoder, dùng để mã hóa mật khẩu
		return new BCryptPasswordEncoder(); // Trả về một đối tượng BCryptPasswordEncoder
	}

	// Trong Spring Security, có các cách xác thực người dùng như: InMemory,
	// Database, LDAP, ...

	@Bean // Bean này sẽ được Spring quản lý
	public InMemoryUserDetailsManager createUserDetailsManager() { // Bean này trả về một đối tượng
																	// InMemoryUserDetailsManager, dùng để tạo ra một
																	// user trong bộ nhớ
		Function<String, String> passwordEncoderFunction = input -> passwordEncoder().encode(input); // Tạo ra một
																										// đối tượng
																										// Function
																										// để mã hóa
																										// mật khẩu

		UserDetails userDetails = User.builder().passwordEncoder(passwordEncoderFunction).username("didannguyen")
				.password("12345").roles("ADMIN", "USER").build(); // Tạo ra một đối tượng UserDetails với việc được mã
																	// hóa mật khẩu, username là didannguyen, 
																	// password là 12345, và có 2 role là
																	// ADMIN và USER
        // Ngoài ra có thể thêm nhiều user khác, và trả về một đối tượng InMemoryUserDetailsManager với danh sách user đó
        // InMemoryUserDetailsManager(userDetails1, userDetails2, ...)
		return new InMemoryUserDetailsManager(userDetails); // Trả về một đối tượng InMemoryUserDetailsManager với
															// user vừa tạo
	}
}

```

### 2.4. Lấy thông tin người dùng hiện tại
Để lấy thông tin người dùng hiện tại, chúng ta sử dụng `SecurityContextHolder` và `Authentication`.

```java
package com.didan.spring_boot_web.controller;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HomeController {

    @GetMapping("/")
    public String home() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication(); // Lấy thông tin của authenticaton từ SecurityContextHolder 
        return "Hello " + authentication.getName(); // Trả về thông tin người dùng hiện tại (username)
    }
}
```

### 2.4. Cấu hình `SecurityFilterChain` trong `Spring Security`
`SecurityFilterChain` là một chuỗi các `Filter` mà `Spring Security` sử dụng để xác thực và kiểm tra quyền truy cập của người dùng.

> Cấu hình để H2-DATABASE hoạt động với Spring Security
```java
package com.didan.spring_boot_web.securtity;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import static org.springframework.security.config.Customizer.withDefaults; // Import thêm Customizer.withDefaults để sử dụng withDefaults() lúc cấu hình HttpSecurity

@Configuration
public class SecurityConfiguration {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http.authorizeRequests(authorizeRequests ->
            authorizeRequests.anyRequest().authenticated() // Tất cả các request khác đều cần phải xác thực mới được truy cập
        ); // Cấu hình cho tất cả các request đều cần phải xác thực mới được truy cập

        http.formLogin(withDefaults()); // Cấu hình cho form login mặc định của Spring Security (username và password), dùng để xác thực người dùng (login)

        http.csrf(csrf -> csrf.disable()); // Tắt chức năng CSRF (Cross-Site Request Forgery) để H2-Database hoạt động

        http.headers(headers -> headers.frameOptions(frame -> frame.disable())); // Tắt chức năng frameOptions, do H2-Database sử dụng frame để hiển thị giao diện (nên phải tắt X-Frame-Options)

        return http.build(); // Trả về một đối tượng SecurityFilterChain
    }
}
```
