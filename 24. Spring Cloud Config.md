# [Spring Cloud Config](https://docs.spring.io/spring-cloud-config/reference/index.html)
## 1. Giới thiệu
`Spring Cloud Config` là một dịch vụ cung cấp cấu hình cho các ứng dụng mà không cần phải cấu hình trực tiếp trong mã nguồn. `Spring Cloud Config` giúp chúng ta quản lý cấu hình ứng dụng một cách dễ dàng và linh hoạt hơn.

`Spring Cloud Config` cung cấp một số tính năng như:
- **Tích hợp với nhiều loại cơ sở dữ liệu cấu hình**: `Spring Cloud Config` hỗ trợ lưu trữ cấu hình trong nhiều loại cơ sở dữ liệu khác nhau như Git, Subversion, Vault, JDBC, Redis, MongoDB, v.v.
- **Tích hợp với nhiều loại ứng dụng**: `Spring Cloud Config` hỗ trợ cấu hình cho nhiều loại ứng dụng khác nhau như Spring Boot, Node.js, Python, v.v.
- **Tích hợp với nhiều môi trường**: `Spring Cloud Config` hỗ trợ cấu hình cho nhiều môi trường khác nhau như Development, Staging, Production, v.v.

## 2. Xây dựng Spring Cloud Config Server
### 2.1. Tạo Spring Boot Project
Chúng ta tạo một Spring Boot Project với các dependencies và cấu hình sau:
```xml
<!-- Cài đặt phiên bản Spring Cloud (Đối cới Spring Boot 3 thì sử dụng bản 2022 trở lên) -->
<properties>
    <spring-cloud.version>2023.0.2</spring-cloud.version>
</properties>
...
<!-- Dependence cho Spring Config Server -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-config-server</artifactId>
</dependency>
...
<!-- Thêm quản lý dependency của Spring Cloud -->
<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
</dependencyManagement>
```
Sau khi mở `project` ta thêm annotation `@EnableConfigServer` vào class `Application` để khai báo `Spring Cloud Config Server`:
```java
@SpringBootApplication
@EnableConfigServer
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

## 3. Đọc thông tin cấu hình từ Spring Cloud Config Server
`Spring Cloud Config` cung cấp một REST API để lấy thông tin cấu hình từ `Spring Cloud Config Server`. 

> Lưu ý: Trước khi làm bất cứ điều gì cần phải đặt tên ứng dụng: `spring.application.name` trong `application.properties` của ứng dụng.

Để đọc thông tin cấu hình, `Spring Cloud Config Server` có 3 cách sau:

### 3.1. Đọc thông tin cấu hình từ `classpath` của `Config Server`
`Classpath` chính là thư mục `resources` của `Spring Project`
#### 3.1.1. Cấu hình ở `Config Server`
Để đọc thông tin cấu hình từ `classpath`, trong `application.properties` của `Config Server` phải thêm thuộc tính:
- `spring.application.name=configserver`: tên ứng dụng, để cho các `Config Client` biết cần lấy thông tin cấu hình từ `Config Server`.
- `spring.profiles.active=native`: để Config Server biết cấu hình sẽ được lấy từ `classpath`.
- `spring.cloud.config.server.native.searchLocations=classpath:/config`: để Config Server biết nơi lưu trữ cấu hình. Chính là thư mục `config` trong thư mục `resources`.

> Lưu ý rằng, các file cấu hình phải được đặt trong thư mục `config` của thư mục `resources`. Và tên file cấu hình phải theo định dạng: `{application}-{profile}.properties`. Trong đó:
- `{application}`: là tên ứng dụng con trong đó `spring.application.name`. Ví dụ `spring.application.name="accounts-service"` => `{application}` = `accounts-service`.
- `{profile}`: là profile của ứng dụng, ví dụ: `dev`, `prod`, `test`.

> Chúng ta chỉ nên lưu trữ cấu hình chung trong thư mục `config` của thư mục `resources`. Còn cấu hình riêng (như cấu hình Database, cấu hình kết nối, v.v.) thì nên lưu trữ trong từng `service` con.
> Nếu dùng `Spring Cloud Config Server` để lưu trữ cấu hình cho các môi trường khác nhau thì trong các `service` con chỉ cần lưu trữ cấu hình chung, chỉ lưu cấu hình riêng của nó.

Sau đó chúng ta có thể truy cập vào web browser với đường dẫn sau để lấy thông tin cấu hình:
```http
http://localhost:8888/{application}/{profile}
<!-- Nếu là profile mặc định thì /profile= /default -->
```

#### 3.1.2. Cấu hình ở `Config Client` (Các `Service` con cần lấy cấu hình)
Để lấy thông tin cấu hình từ `Config Server`, chúng ta cần cài đặt, thêm các dependencies của `Config Client` vào `pom.xml` của các `service` con như sau:
```xml
<!-- Cài đặt phiên bản Spring Cloud (Đối cới Spring Boot 3 thì sử dụng bản 2022 trở lên) -->
<properties>
    <spring-cloud.version>2023.0.2</spring-cloud.version>
</properties>
...
<!-- Dependence cho Spring Config Client -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>
...
<!-- Thêm quản lý dependency của Spring Cloud -->
<dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-dependencies</artifactId>
        <version>${spring-cloud.version}</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
</dependencyManagement>
```

Sau đó cấu hình `application.properties` của `service` con như sau:
```properties
# Tên ứng dụng
spring.application.name="accounts-service"
# Profile mà ứng dụng muốn lấy cấu hình từ Config Server, nếu không có thì mặc định là "default"
spring.profiles.active="dev"
# Địa chỉ Config Server
spring.config.import="option:configserver:http://localhost:8071"
## option: có thể có hoặc không, nó nói rằng nếu không tìm thấy cấu hình thì sẽ không báo lỗi, ứng dụng tiếp tục chạy (Nếu các service không cần cấu hình thì không cần thiết)
## configserver: là tên của Config Server đã khai báo trong file application.properties của Config Server với key: spring.application.name
## http://localhost:8071: là địa chỉ của Config Server
```

### 3.2. Đọc thông tin cấu hình từ thư mục `file system` của hệ thống triển khai `Config Server`
Lợi ích của việc lưu trữ cấu hình trong hệ thống file system là dễ dàng quản lý cấu hình, dễ dàng backup và restore cấu hình. Tránh việc mất cấu hình khi `Config Server` bị lỗi.

Các bước cấu hình tương tự như cấu hình từ `classpath` chỉ khác ở:
- `spring.cloud.config.server.native.searchLocations=file:///path//to//config`: để Config Server biết nơi lưu trữ cấu hình trong hệ thống file system.
> Lưu ý: Sau `file` sẽ là `3 dấu /` và đường dẫn đến thư mục chứa cấu hình được ngăn cách bởi `2 dấu /`.

### 3.3. Đọc thông tin cấu hình từ `Git` (Khuyến nghị)
Lợi ích của việc lưu trữ cấu hình trong `Git` là dễ dàng quản lý cấu hình, dễ dàng theo dõi lịch sử cấu hình, dễ dàng phân quyền truy cập cấu hình.

Các bước cấu hình tương tự như cấu hình từ `classpath` và `file system` chỉ khác ở:
- `spring.profiles.active=git`: để Config Server biết cấu hình sẽ được lấy từ `Git`.
- Thêm các thuộc tính cấu hình `Git` vào `application.properties` của `Config Server`:
```properties
# Đường dẫn đến Git Repository chứa cấu hình
spring.cloud.config.server.git.uri="URL của Git Repository chứa cấu hình"
# Nếu file cấu hình nằm ở thư mục con của Git Repository thì cần khai báo đường dẫn đến thư mục chứa cấu hình
spring.cloud.config.server.git.searchPaths="Đường dẫn đến thư mục chứa cấu hình trong Git Repository"
# Nếu cần phải xác thực để lấy cấu hình từ Git Repository thì cần khai báo username và password
spring.cloud.config.server.git.username="username"
spring.cloud.config.server.git.password="password"
# Chọn branch cần lấy cấu hình
spring.cloud.config.server.git.default-label="master"
# Set timeout khi lấy cấu hình từ Git Repository (mặc định là 5s)
spring.cloud.config.server.git.timeout=5
# Cho phép clone Git Repository khi khởi động Config Server
spring.cloud.config.server.git.clone-on-start=true
# Bắt buộc Config Server phải clone Git Repository khi khởi động, ghi đè cấu hình cũ
spring.cloud.config.server.git.force-pull=true
```

Thông tin chi tiết tại [Spring Config Git Backend](https://docs.spring.io/spring-cloud-config/reference/server/environment-repository/git-backend.html)

### 3.4. Mã hóa thông tin trong file cấu hình.
Thông thường, sử dụng đọc thông tin cấu hình từ `Git` thì các thông tin nếu không mã hóa thì sẽ rất nguy hiểm. Vì vậy, chúng ta cần mã hóa thông tin cần thiết trong file cấu hình.

Để mã hóa thông tin trong file cấu hình, chúng ta cần thêm các thuộc tính sau vào `application.properties` của `Config Server`:
```properties
# Mã hóa thông tin trong file cấu hình
encrypt.key="random key"
```

Sau đó chúng ta có thể mã hóa thông tin bằng cách sử dụng `Spring Cloud Config Server` với đường dẫn `/encrypt` để mã hóa thông tin và `/decrypt` để giải mã thông tin.
```bash
curl -X POST http://localhost:8071/encrypt -d "value cần mã hóa"
```

Sau khi mã hóa xong, chúng ta thêm thông tin đã mã hóa vào file cấu hình (Git hoặc local file...) với `{cipher}` ở trước thông tin đã mã hóa:
```properties
# Mã hóa thông tin trong file cấu hình
spring.datasource.password="{cipher}password đã mã hóa"
```

## 4. Refresh cấu hình của `Service` con mỗi khi thay đổi cấu hình trên `Config Server`
Mặc định, khi thay đổi các cấu hình, `Config Server` luôn gọi đến các cấu hình mới nhất bởi vì mỗi lần gọi đến, `Config Server` không lưu cache cũ mà lấy cấu hình mới nhất từ `Git` hoặc `file system`.

Tuy nhiên, đối với các `service` con, chúng chỉ kết nối tới `Config Server` 1 lần duy nhất trong quá trình khởi động. Để `service` con có thể lấy cấu hình mới nhất từ `Config Server` mỗi khi thay đổi cấu hình, chúng ta cần sử dụng `Actuator` để refresh cấu hình.

### 4.1. Sử dụng `Actuator` để refresh cấu hình
#### 4.1.1. Cấu hình ở `Service` con
Chúng ta cần thêm các dependencies của `Actuator` vào `pom.xml` của `service` con như sau:
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

Sau đó cấu hình `application.properties` của `service` con như sau:
```properties
# Cho phép refresh cấu hình
management.endpoints.web.exposure.include=refresh
```

#### 4.1.2. Tiến hành Refresh cấu hình của `Service` con
Để refresh cấu hình của `Service` con, chúng ta cần gọi đến `Actuator` của `Service` con với đường dẫn `/actuator/refresh`:
```bash
curl -X POST http://localhost:8080/actuator/refresh
```
### 4.2. Sử dụng `Spring Cloud Bus` + `RabbitMQ` để refresh cấu hình
Để giải quyết vấn đề refresh cấu hình của nhiều `service` con, chúng ta sử dụng `Spring Cloud Bus` kết hợp với `RabbitMQ` để refresh cấu hình của tất cả các `service` con một cách tự động.

Thông thường, sử dụng `Actuator` để refresh cấu hình của từng `service` con sẽ rất mất thời gian và công sức. Nếu có hàng trăm `service` con thì việc refresh phải thực hiện hàng trăm lần.

Với `Spring Cloud Bus` + `RabbitMQ`, chúng ta chỉ cần refresh cấu hình ở bất kỳ `Service` con nào, tất cả các `service` con khác sẽ tự động refresh cấu hình.

#### 4.2.1. Cấu hình `RabbitMQ`
Trước tiên chúng ta phải cài đặt `RabbitMQ`, nếu sử dụng `Docker` thì chạy lệnh sau:
```bash
docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3.13-management
```

#### 4.2.2. Cấu hình `Spring Cloud Bus` + `RabbitMQ` ở tất cả `Service` con và `Config Server`
Chúng ta cần thêm các dependencies của `Spring Cloud Bus` vào `pom.xml` của `service` con và `Config Server` như sau:
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bus-amqp</artifactId>
    <version>4.1.1</version>
</dependency>
```

Sau đó cấu hình `application.properties` của `service` con và `Config Server` như sau:
```properties
# Cấu hình RabbitMQ
## Địa chỉ RabbitMQ
spring.rabbitmq.host="localhost"
## Port của RabbitMQ
spring.rabbitmq.port=5672
## Username của RabbitMQ
spring.rabbitmq.username="guest"
## Password của RabbitMQ
spring.rabbitmq.password="guest"

# Cấu hình Spring Cloud Bus cho phép refresh cấu hình
management.endpoints.web.exposure.include=busrefresh
```

#### 4.2.3. Tiến hành Refresh cấu hình của tất cả `Service` con
Để refresh cấu hình của tất cả `Service` con, chúng ta cần gọi đến `Actuator` của `Service` con với đường dẫn `/actuator/busrefresh`:
```bash
curl -X POST http://localhost:8080/actuator/busrefresh
```

### 4.3. Sử dụng `Spring Cloud Config Monitor` + `Webhook` + `Spring Cloud Bus` + `RabbitMQ` để tự động refresh cấu hình mỗi khi thay đổi cấu hình trên `Config Server` (Real-time)
Để giải quyết vấn đề refresh cấu hình mỗi khi thay đổi cấu hình trên `Config Server`, chúng ta sử dụng `Spring Cloud Config Monitor` kết hợp với `Webhook` để tự động refresh cấu hình của tất cả `service` con mỗi khi thay đổi cấu hình trên `Config Server`.

Nguyên lý là sau khi thay đổi cấu hình trên `Config Server`, `Spring Cloud Config Monitor` sẽ gửi thông báo tới `Webhook` và `Spring Cloud Bus` sẽ tự động refresh cấu hình của tất cả `service` con.

#### 4.3.1. Cấu hình `Spring Cloud Config Monitor` + `Webhook` + `Spring Cloud Bus` + `RabbitMQ` ở `Config Server`
Cấu hình cài đặt `Spring Cloud Bus` + `RabbitMQ` tương tự như ở phần 4.2.

Chúng ta cần thêm các dependencies của `Spring Cloud Config Monitor` vào `pom.xml` của `Config Server` như sau:
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-config-monitor</artifactId>
</dependency>
```

Sau đó cấu hình `application.properties` của `Config Server` như sau:
```properties
# Cấu hình RabbitMQ (Tương tự 4.2)
# Cấu hình Spring Cloud Bus cho phép refresh cấu hình, cho phép webhook gửi thông báo
management.endpoints.web.exposure.include=busrefresh,monitor
## hoặc
management.endpoints.web.exposure.include="*"
```

#### 4.3.2. Cài `Webhook` để nhận thông báo từ `Spring Cloud Config Monitor`
Ví dụ, sử dụng `Github Webhook` để nhận thông báo từ `Spring Cloud Config Monitor`:
- Truy cập vào `Settings` của `Repository` trên `Github`.
- Chọn `Webhooks`.
- Click vào `Add webhook`.
- Điền thông tin `Payload URL` là địa chỉ của `Spring Cloud Config Monitor` (Ví dụ: `{địa_chi_spring_config_server/monitor`).
- Chọn `Content type` là `application/json`.
- Chọn `Just the push event`.

Như vậy mỗi khi thay đổi cấu hình, commit và push lên `Github`, `Spring Cloud Config Monitor` sẽ gửi thông báo tới `Webhook` và `Spring Cloud Bus` sẽ tự động refresh cấu hình của tất cả `service` con.

#### 4.3.3. Cài `Webhook` đối với địa chỉ là `localhost`
Vì trên các `Repository` không cho phép `Payload URL` là `localhost`, nên chúng ta cần sử dụng `https://console.hookdeck.com` để tạo `Webhook` với `Payload URL` là `localhost`.

Truy cập vào `https://console.hookdeck.com`, chọn `Add Destination`, và làm theo hướng dẫn.

Khi chạy terminal với lệnh sau:
```bash
hookdeck listen 8071 Source ## 8071 là port của Config Server
```
Một thông báo hiện ra `? What path should the events be forwarded to (ie: /webhooks)?` chúng ta nhập `/monitor`.

Tiếp tục, một thông báo hiện ra `What's your connection label (ie: My API)?` chúng ta nhập `localhost`.

Sau đó, copy địa chỉ `Event URL` và dán vào `Payload URL` của `Webhook` trên `Github`.

## 5. Tạo Docker Compose cho `Spring Cloud Config Server` + `Service` con
### 5.1. Khái niệm `Liveness` và `Readiness`
- `Liveness`: là khả năng của `Container` để xác định xem `Container` có hoạt động hay không. Nếu `Container` không hoạt động thì `Kubernetes` sẽ khởi động lại `Container`.
- `Readiness`: là khả năng của `Container` để xác định xem `Container` đã sẵn sàng để nhận request từ bên ngoài hay chưa. Nếu `Container` chưa sẵn sàng thì `Kubernetes` sẽ không chuyển request tới `Container`.

Trong `Spring Boot`, chúng ta cần cài đặt dependence `Actuator` để xác định `Liveness` và `Readiness` của `Container`. Sau đó cấu hình `application.properties` ở trong `Spring Cloud Config Server` như sau:
```properties
# Cấu hình cho phép truy cập vào các endpoint của Actuator
management.endpoints.web.exposure.include="*"
# Cho phép xác định Liveness
management.health.liveness-state.enabled=true 
# Cho phép xác định Readiness
management.health.readiness-state.enabled=true
# Cho phép dò sức khỏe của Container
management.endpoint.health.probes.enabled=true
```
Đường dẫn để xác định `Liveness` và `Readiness` của `Container` trong `Spring Boot`:
- `/actuator/health/liveness`: để xác định `Liveness`. Nếu trả về `status: UP` thì `Container` hoạt động, ngược lại thì không hoạt động.
- `/actuator/health/readiness`: để xác định `Readiness`. Nếu trả về `status: UP` thì `Container` đã sẵn sàng, ngược lại thì chưa sẵn sàng.

### 5.2. Thêm `healthcheck` vào `Docker-Compose` cho `Spring Cloud Config Server`
Sau khi cài đặt `Actuator` và cấu hình `Liveness` và `Readiness` trong `Spring Cloud Config Server`, chúng ta cần thêm `health-check` vào `Docker-Compose` cho `Spring Cloud Config Server` như sau:
```yaml
...
services:
  config-server:
    image: "config-server"
    container_name: "config-server"
    ports:
      - "8071:8071"
    healthcheck:
      test: "curl --fail http://localhost:8071/actuator/health/readiness | grep UP || exit 1" # Kiểm tra Readiness, nếu trả về UP thì Container sẵn sàng, ngược lại thì không sẵn sàng và Container sẽ exit
      interval: 10s # Thời gian kiểm tra 
      timeout: 5s # Thời gian tối đa để kiểm tra
      retries: 5 # Số lần kiểm tra lại khi thất bại
      start_period: 10s # Thời gian bắt đầu kiểm tra sau khi Container khởi động
...
```

> Config `healcheck` với Service `RabbitMQ`:
```yaml
...
services:
  rabbitmq:
    image: "rabbitmq:3.13-management"
    container_name: "rabbitmq"
    hostname: "rabbitmq"
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity # Kiểm tra kết nối tới RabbitMQ
      interval: 10s # Thời gian kiểm tra 
      timeout: 5s # Thời gian tối đa để kiểm tra
      retries: 5 # Số lần kiểm tra lại khi thất bại
      start_period: 5s # Thời gian bắt đầu kiểm tra sau khi Container khởi động
...
```

### 5.3. Thêm `depends_on` vào `Docker-Compose` cho `Service` con dựa vào hoạt động, healthcheck của `Service` khác
Sau khi cài đặt `Actuator` và cấu hình `Liveness` và `Readiness` trong `Spring Cloud Config Server`, chúng ta cần thêm `depends_on` vào `Docker-Compose` cho `Service` con dựa vào hoạt động, `healthcheck` của `Spring Cloud Config Server` như sau:
```yaml
...
services:
  accounts-service:
    image: "accounts-service"
    container_name: "accounts-service"
    ports:
      - "8080:8080"
    depends_on:
      config-server: # Phụ thuộc vào Config Server
        condition: service_healthy # Chờ đến khi Config Server sẵn sàng, với điều kiện healthcheck trả về UP
        #condition: service_started # Chờ đến khi Config Server khởi động, không quan tâm đến healthcheck
        #condition: service_completed_successfully # Chờ đến khi Config Server hoàn thành, không quan tâm đến healthcheck
...
```

### 5.4. Thêm `networks` vào `Docker-Compose` để kết nối giữa các `Service`
Trong `Docker`, mỗi 1 `container` là 1 mạng riêng biệt, vì vậy không thể sử dụng `localhost` để kết nối giữa các `container`. Để giải quyết vấn đề này, chúng ta cần thêm `networks` vào `Docker-Compose` để kết nối giữa các `Service` như sau:
```yaml
# Cài đặt mạng với chế độ bridge
networks:
  my-network:
    driver: bridge
```
Sau đó thêm `networks` vào từng `Service` như sau:
```yaml
...
services:
  config-server:
    image: "config-server"
    container_name: "config-server"
    ports:
      - "8071:8071"
    networks:
      - my-network
...
```
> Như vậy, ví dụ khi cần kết nối giữa `Config Server` và `Service` con, chúng ta chỉ cần sử dụng `http://config-server:8071` thay vì `http://localhost:8071`.

### 5.5. Ví dụ tạo file `docker-compose.yml` cho `Spring Cloud Config Server` + `Service` con + `RabbitMQ`
Trước tiên, chúng ta cần tạo `images` bằng các cách đã nêu ở `22. Build Image Spring Boot.md` và push lên `Docker Hub`.
Sau đó tạo file `docker-compose.yml` như sau:
```yaml
services:
  rabbitmq:
    image: rabbitmq:3.13-management # Sử dụng image RabbitMQ
    container_name: rabbitmq # Tên container
    hostname: rabbitmq # Hostname, thay vì localhost
    ports:
      - "5672:5672" # Port kết nối
      - "15672:15672" # Port quản lý
    healthcheck: # Kiểm tra kết nối tới RabbitMQ
      test: rabbitmq-diagnostics check_port_connectivity # Kiểm tra kết nối tới RabbitMQ
      interval: 10s # Thời gian kiểm tra
      timeout: 5s # Thời gian tối đa để kiểm tra
      retries: 10 # Số lần kiểm tra lại khi thất bại
      start_period: 5s # Thời gian bắt đầu kiểm tra sau khi Container khởi động
    networks: # Kết nối mạng
      - didan # Tên mạng
  
  configserver: # Service Config Server
    image: dannguyenmessi/configserver:v1 # Sử dụng image Config Server
    container_name: configserver # Tên container
    ports:
      - "8071:8071"
    healthcheck:  # Kiểm tra Readiness, nếu trả về UP thì Container sẵn sàng, ngược lại thì không sẵn sàng và Container sẽ exit
      test: "curl --fail http://localhost:8071/actuator/health/readiness | grep UP || exit 1" 
      interval: 10s 
      timeout: 5s
      retries: 10
      start_period: 10s
    networks: # Kết nối mạng
      - didan
    depends_on: # Phụ thuộc vào RabbitMQ
      rabbitmq: 
        condition: service_healthy # Chờ đến khi RabbitMQ sẵn sàng, với điều kiện healthcheck trả về UP
    environment: # Các biến môi trường sẽ thay thế các biến môi trường trong file application.properties
      SPRING_APPLICATION_NAME: "configserver" # # Tên ứng dụng (Bắt buộc phải có mặc dù đã khai báo trong application.properties) do lỗi của Docker
      SPRING_PROFILES_ACTIVE: "default" # Profile mặc định (spring.profiles.active)
      SPRING_RABBITMQ_HOST: "rabbitmq" # Hostname của RabbitMQ, thay vì localhost
  
  accounts:
    image: dannguyenmessi/accounts:v1
    container_name: accounts
    ports:
      - "8080:8080"
    networks:
      - didan
    depends_on:
      configserver:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_NAME: "accounts" # Tên ứng dụng (Bắt buộc phải có mặc dù đã khai báo trong application.properties) do lỗi của Docker
      SPRING_PROFILES_ACTIVE: "default"
      SPRING_RABBITMQ_HOST: "rabbitmq"
      SPRING_CONFIG_IMPORT: "configserver:http://configserver:8071" # Import cấu hình từ Config Server (thay vì configserver: http://localhost:8071)

  loans:
    image: dannguyenmessi/loans:v1
    container_name: loans
    ports:
      - "8090:8090"
    networks:
      - didan
    depends_on:
      configserver:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_NAME: "loans" # Tên ứng dụng (Bắt buộc phải có mặc dù đã khai báo trong application.properties) do lỗi của Docker
      SPRING_PROFILES_ACTIVE: "default"
      SPRING_RABBITMQ_HOST: "rabbitmq"
      SPRING_CONFIG_IMPORT: "configserver:http://configserver:8071"
  
  cards:
    image: dannguyenmessi/cards:v1
    container_name: cards
    ports:
      - "9000:9000"
    networks:
      - didan
    depends_on:
      configserver:
        condition: service_healthy
    environment:
      SPRING_APPLICATION_NAME: "cards" # Tên ứng dụng (Bắt buộc phải có mặc dù đã khai báo trong application.properties) do lỗi của Docker
      SPRING_PROFILES_ACTIVE: "default"
      SPRING_RABBITMQ_HOST: "rabbitmq"
      SPRING_CONFIG_IMPORT: "configserver:http://configserver:8071"

networks:
  didan:
    driver: bridge # Chế độ bridge, cho phép kết nối giữa các container qua tên container thay vì localhost
```