# A. Giới thiệu các khái niệm chung về Kubernetes
## 1. Kubernetes là gì?
`Kubernetes` là một hệ thống mã nguồn mở giúp quản lý các container. `Kubernetes` giúp bạn tự động hóa việc triển khai, mở rộng và quản lý các ứng dụng chứa trong các container. Nó là hệ thống quản lý container phổ biến nhất hiện nay và nó là một đám mây trung tính (cloud-neutral) với khả năng chạy trên nhiều hệ thống đám mây công cộng, riêng tư hoặc hệ thống vật lý.

`Kubernetes` cung cấp cho người dùng với 1 `framework` để chạy các hệ thống phân tán một cách ổn định. Nó quan tâm tới việc mở rộng, khả năng chịu lỗi cho ứng dụng và cung cấp các mẫu triển khai ứng dụng. Nó cung cấp với các tính năng như:
- `Service discovery and load balancing`: `Kubernetes` có thể khám phá các dịch vụ và phân phối các yêu cầu đến các dịch vụ đó. **`Có thể thay thế Eureka Server trong Spring Cloud`**.
- `Container & storage orchestration`: `Kubernetes` cho phép bạn tự động chuyển các container đến các máy chủ mới khi cần thiết.
- `Automated rollouts and rollbacks`: `Kubernetes` cho phép bạn thực hiện triển khai mới mà không cần gián đoạn dịch vụ cũng như quay lại phiên bản cũ nếu cần.
- `Self-healing`: `Kubernetes` có khả năng tự động khôi phục các container khi chúng bị lỗi.
- `Secret and configuration management`: `Kubernetes` cho phép bạn quản lý và lưu trữ các thông tin nhạy cảm như `password`, `OAuth tokens` và `SSH keys`.

## 2. Kiến trúc của Kubernetes
`Kubernetes` có kiến trúc `master-slave` với các thành phần chính như sau:
1. `Control Panel/Master Node`: Chịu trách nhiệm quản lý toàn bộ `cluster`. Nó giám sát việc kiểm tra tình trạng của tất cả các `node` trong `cluster`, lưu trữ thông tin của các thành viên liên quan đến các `node` khác nhau, lập kế hoạch cho các `container` được lên lịch cho các `Worker Node` nhất định, giám sát các `container` và `node`, v.v. Vì vậy, khi một `Worker node` bị lỗi, `Master node` sẽ di chuyển khối lượng công việc từ `node` bị lỗi đến `Worker Node` khỏe mạnh khác.
    - `API Server`: Là giao diện chính để tương tác với `K8s cluster`. Nó show ra các API của `k8s`, cho phép người dùng và các thành phần khác giao tiếp với các `cluster`. Tất cả lệnh điều khiển, hoạt động của quản trị viên được gửi tới `API Server` và nó sẽ thực thi và xác thực các yêu cầu đó.
    - `Scheduler`: Có trách nhiệm đặt các `Pod` vào các `node` có sẵn trong `cluster`. Nó sẽ tính đến các yếu tố như `yêu cầu tài nguyên`, `mối quan hệ`, `chống đối quan hệ`, và các ràng buộc khác để đưa ra quyết định thông min xem `node` nào sẽ chứa `Pod`. `Scheduler` liên tục theo dõi các `cluster` đảm bảo các `Pod` được phân phối 1 cách tối ưu.
    - `Controller Manager`: Trình quản lý việc duy trì các `cluster`. Nó xử lý các lỗi `node`, nhân bản các thành phần, đảm bảo đúng số lượng `Pod` chạy và các `controller` khác. Nó luôn giữ hệ thống ở trạng thái mong muốn bằng cách so sánh trạng thái hiện tại với trạng thái mong muốn.
    - `etcd`: Là kho lưu trữ `key-value` phân tán, đóng vai trò là kho lưu trữ dữ liệu chính của `cluster`. Nó lưu trữ các `dữ liệu cấu hình` và `trạng thái mong muốn` của hệ thống, bao gồm thông tin về `Pods`, `Services`, `Replication Controllers`, `Endpoints` và `Nodes`. `API Server` tương tác với `etcd` để đọc và ghi dữ liệu `cluster`.
2. `Worker Node`: Không gì khác ngoài một `máy ảo` (VM) chạy trên đám mây hoặc tại chỗ. Vì vậy, bất kỳ phần cứng nào có khả năng chạy thời gian chạy container đều có thể trở thành `Worker Node`. Các `node` này hiển thị khả năng tính toán, lưu trữ và kết nối mạng cơ bản cho các ứng dụng. Các `Worker Node` thực hiện công việc nặng nhọc cho ứng dụng chạy bên trong `Kubernetes Cluster`. Đồng thời, các `node` này tạo thành một `cluster` - việc phân công khối lượng công việc được thực hiện bởi thành phần `Master Node`, tương tự như cách người quản lý giao nhiệm vụ cho một thành viên trong nhóm. Bằng cách này, chúng sẽ có thể đạt được khả năng chịu lỗi và nhân rộng.
    - `Pod` là đơn vị triển khai nhỏ nhất trong Kubernetes cũng như container là đơn vị triển khai nhỏ nhất trong Docker. Để hiểu một cách dễ hiểu, chúng ta có thể nói rằng `pod` không là gì ngoài những `máy ảo nhẹ trong thế giới ảo`. Mỗi nhóm bao gồm một hoặc nhiều container. Mỗi khi một nhóm hoạt động, nó sẽ nhận được một địa chỉ IP mới với dải IP ảo do giải pháp mạng nhóm chỉ định.
    - `Kubelet`: Là một thành phần chạy trên mỗi `Worker Node` và giao tiếp với các thành phần trong `control plane`. Nó nhận được hướng dẫn từ `control plane`, chẳng hạn như tạo và xóa `Pod` và đảm bảo duy trì trạng thái mong muốn của `Pod` trong `node`. `Kubelet` chịu trách nhiệm cho việc `bắt đầu`, `dừng lại`, `giám sát` các `container` dựa trên thông số kỹ thuật của `Pod`.
    - `Kube-proxy`: Là một proxy mạng chạy trên mỗi `Worker Node` trong `Cluster`, triển khai một phần nội dung của `Kubernetes Service`. `Kube-proxy` duy các `quy tắc` mạng trên các `node`. Các `quy tắc` này cho phép giao tiếp mạng tới `Pod` từ các phiên mạng bên trong hoặc bên ngoài `Cluster`.
    - `Container Runtime`: Chịu trách nhiệm `chạy` và `quản lý` các `container` trên `Worker Node`. Kubernetes hỗ trợ nhiều `container runtime`, trong đó Docker được sử dụng phổ biến nhất. Các `runtime` khác như `containerd` và `rkt` cũng được hỗ trợ. `Container Runtime` lấy `container image`, tạo và quản lý các phiên bản `container` cũng như xử lý các hoạt động trong vòng đời của `container`.

# B. Cài đặt `Kubernetes` trên `Docker Desktop` (Xây dụng Kubernetes cục bộ)
## 1. Settings trong `Docker Desktop`
Để deploy `Kubernetes` trên `Docker Desktop`, xem hướng dẫn tại đây [Deploy on Kubernetes with Docker Desktop](https://docs.docker.com/desktop/kubernetes/)

## 2. Cài đặt `Helm`
`Helm` là một công cụ quản lý gói cho `Kubernetes`. Nó cho phép bạn định nghĩa, cài đặt và quản lý các ứng dụng `Kubernetes`. Để cài đặt `Helm`, xem hướng dẫn tại đây [Installing Helm](https://helm.sh/docs/intro/install/)

Sau khi cài xong, kiểm tra phiên bản `Helm` bằng câu lệnh:
```bash
helm version
```

## 3. Cài `Kubernetes UI` (Dashboard) trên máy cục bộ
### 3.1. Để cài `Kubernetes UI` trên máy cục bộ, trước hết cần phải có `Kubernetes` và cần cài `Helm` trước. Sau đó, tham khảo hướng dẫn tại đây [Kubernetes Dashboard](https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/)

Câu lệnh cài đặt `Kubernetes UI`:
```bash
# Add thư viện Kubernetes Dashboard 
helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/

# Cài đặt Kubernetes Dashboard với namespace kubernetes-dashboard
helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --create-namespace --namespace kubernetes-dashboard
```
### 3.2. Sau khi cài đặt xong, sử dụng câu lệnh sau để kiểm tra xem `kubernetes-dashboard-kong-proxy` đã được cài đặt thành công chưa:
```bash
# Lấy ra các service trong namespace kubernetes-dashboard
kubectl -n kubernetes-dashboard get svc
```

### 3.3. Để khởi động `Kubernetes UI`, sử dụng câu lệnh sau:
```bash
# Khởi động Kubernetes UI
kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-kong-proxy 8443:443
```
> Sau khi khởi động thành công, truy cập vào `https://localhost:8443` để xem `Kubernetes UI`. Lưu ý, cần phải giữ phiên làm việc của Terminal để chạy `Kubernetes UI`.

### 3.4. Để đăng nhập vào `Kubernetes UI`, cần phải lấy ra `token` để đăng nhập. Trước hết cần phải tạo một `Service Account` và `Cluster Role Binding` cho `Service Account` đó.
Tham khảo các bước tại [Creating sample user](https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md)

1. Tạo một `Service Account` với tên `admin-user` trong namespace đã tạo là `kubernetes-dashboard`, cấu hình trong file `dashboard-adminuser.yaml`:
    >`dashboard-adminuser.yaml`
    ```yaml
    apiVersion: v1 # Version của API dùng để tạo Service Account
    kind: ServiceAccount # Loại tài khoản 
    metadata: # Thông tin về Service Account
        name: admin-user # Tên Service Account (giống như username)
        namespace: kubernetes-dashboard # Namespace của Service Account (giống như group)
    ```
    Sau đó, sử dụng câu lệnh sau để tạo `Service Account`:
    ```bash
    kubectl apply -f dashboard-adminuser.yaml
    ```

2. Tạo `Cluster Role Binding` để cấp quyền cho `Service Account` vừa tạo, cấu hình trong file `dashboard-adminuser-rolebinding.yaml`:
    >`dashboard-adminuser-rolebinding.yaml`
    ```yaml
    apiVersion: rbac.authorization.k8s.io/v1 # Version của API dùng để tạo Cluster Role Binding
    kind: ClusterRoleBinding # Loại quyền
    metadata: # Thông tin về Cluster Role Binding
        name: admin-user # Tên Cluster Role Binding
    roleRef: # Thông tin về Role
        apiGroup: rbac.authorization.k8s.io # Group của Role
        kind: ClusterRole # Loại Role
        name: cluster-admin # Tên Role, bất kỳ người dùng nào được gán Role này sẽ có quyền quản trị toàn bộ Cluster
    subjects: # Danh sách các đối tượng được cấp quyền
    - kind: ServiceAccount # Loại đối tượng được cấp quyền
        name: admin-user # Tên đối tượng
        namespace: kubernetes-dashboard # Namespace của đối tượng
    ```
    Sau đó, sử dụng câu lệnh sau để tạo `Cluster Role Binding`:
    ```bash
    kubectl apply -f dashboard-adminuser-rolebinding.yaml
    ```

3. Đây là bước tùy chọn. Nếu muốn tạo ra `token` của user `admin-user` để đăng nhập vào `Kubernetes UI` một cách lâu dài, vĩnh viễn thì cần thêm cấu hình sau vào file `secret.yaml`. Còn không thì mỗi lần đăng nhập sẽ phải tạo `token` mới.
    >`secret.yaml`
    ```yaml
    apiVersion: v1 # Version của API dùng để tạo Secret
    kind: Secret # Loại Secret
    metadata: # Thông tin về Secret
        name: admin-user # Tên Secret
        namespace: kubernetes-dashboard # Namespace của Secret
        annotations: # Các chú thích
            kubernetes.io/service-account.name: admin-user # Tên Service Account
    type: kubernetes.io/service-account-token # Loại Secret
    ```
    Sau đó, sử dụng câu lệnh sau để tạo `Secret`:
    ```bash
    kubectl apply -f secret.yaml
    ```
    > Lưu ý: Nếu không tạo `Secret`, mỗi lần đăng nhập vào `Kubernetes UI` sẽ phải tạo `token` mới.

4. Lấy ra `token` của `Service Account` `admin-user` để đăng nhập vào `Kubernetes UI`:
    ```bash
    # Lấy ra token của Service Account admin-user
    kubectl -n kubernetes-dashboard create token admin-user
    ```
    Trong đó `-n` là `namespace` của `Service Account` và `create token` là câu lệnh để tạo `token` cho `Service Account`.

5. Sau khi lấy ra `token`, truy cập vào `Kubernetes UI` và nhập `token` để đăng nhập.

# C. Container Orchestration (Sự điều phối, quản lý các container) sử dụng Kubernetes



# Các câu lệnh cơ bản trong Kubernetes
1. `kubectl config get-contexts`: Hiển thị danh sách các `context` trong `kubeconfig`. 
2. `kubectl config use-context <name-context>`: Chuyển đổi giữa các `context` trong `kubeconfig`.
3. `kubectl get nodes`: Hiển thị danh sách các `node` trong `cluster`.